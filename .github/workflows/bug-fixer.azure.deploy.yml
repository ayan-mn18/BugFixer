# Azure VM Deployment Workflow
# This workflow deploys the BugFixer application to an Azure VM
# using a self-hosted GitHub Actions runner

name: BugFixer Azure Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: [self-hosted, bug-fixer]  # Runs on your Azure VM runner

    strategy:
      matrix:
        node-version: [22.x]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ” Create .env file
      run: |
        touch .env
        echo "${{ secrets.BUGFIXER_PROD }}" > .env

    - name: ğŸ› ï¸ Build project
      run: npm run build --if-present

    - name: ğŸ“¦ Install PM2 globally (if not exists)
      run: |
        if ! command -v pm2 &> /dev/null; then
          echo "ğŸ“¦ Installing PM2..."
          npm i -g pm2
        else
          echo "âœ… PM2 already installed"
        fi

    - name: ğŸ›‘ Stop and delete existing BugFixer PM2 process
      run: |
        if pm2 describe bugfixer > /dev/null 2>&1; then
          echo "ğŸ›‘ Stopping existing bugfixer process..."
          pm2 stop bugfixer
          pm2 delete bugfixer
          echo "âœ… Existing bugfixer process stopped and deleted"
        else
          echo "â„¹ï¸ No existing bugfixer process found"
        fi

    - name: ğŸš€ Start new BugFixer PM2 process
      run: |
        echo "ğŸš€ Starting new bugfixer process..."
        pm2 start dist/server.js --name bugfixer
        pm2 save
        echo "âœ… bugfixer started successfully"

    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸ“Š PM2 Status:"
        pm2 status
        echo ""
        echo "ğŸ” Checking if BugFixer is running..."
        sleep 5
        if pm2 describe bugfixer | grep -q "online"; then
          echo "âœ… BugFixer is running successfully!"
        else
          echo "âŒ BugFixer may have issues. Check logs with: pm2 logs bugfixer"
          exit 1
        fi
